#textdomain wesnoth-AD

[scenario]
    id=AD_07
    name= _ "A Fateful Battle"
    map_data="{~add-ons/Ashievieres_Dogs/maps/AD_07.map}"
    turns=-1
    next_scenario=null
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes
    current_time=4

    {DEFAULT_SCHEDULE}

    {SCENARIO_MUSIC "battle-epic.ogg"}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_city_falls.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
    {EXTRA_SCENARIO_MUSIC "northern_mountains.ogg"}

    {AD_TRACK {JOURNEY_07_NEW} }

    [label]
        x,y=38,8
        text=_ "Northern gates"
        immutable=yes
    [/label]

    [label]
        x,y=48,28
        text=_ "Eastern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,23
        text=_ "Southern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,12
        text=_ "Dan-Tonk citadel"
        immutable=yes
    [/label]

    #define FIREBALL MAGE_ID X Y

        [animate_unit]
            flag=attack
                [filter]
                    id={MAGE_ID}
                [/filter]
                [facing]
                    x,y=15,12
                [/facing]
                [primary_attack]
                    range=ranged
                    type=fire
                [/primary_attack]
            hits=yes
        [/animate_unit]

        [scroll_to]
            x,y={X},{Y}
        [/scroll_to]

        {QUAKE "explosion.ogg"}
        {QUAKE "rumble.ogg"}
        {QUAKE "cave-in.ogg"}

        [item]
            halo="data/add-ons/Ashievieres_Dogs/images/projectiles/fireball-impact-[1~17].png"
            x={X}
            y={Y}
        [/item]

        [delay]
            time=900
        [/delay]

        [harm_unit]
            [filter]
                [filter_location]
                    x,y={X},{Y}
                [/filter_location]
            [/filter]
            damage_type=fire
            amount=25
            kill=yes
            fire_event=yes
            animate=no
            experience=no
        [/harm_unit]

        {REMOVE_IMAGE {X} {Y}}

        [terrain]
            x={X}
            y={Y}
            terrain=^Xo
            layer=overlay
        [/terrain]

        [item]
            x={X}
            y={Y}
            halo=scenery/flames[01~15].png:50
        [/item]   
        [time_area]
            {LIGHT_SCHEDULE 4}
            id=campfire_{X}_{Y}
            x={X}
            y={Y}
        [/time_area]     
        [sound_source]
            id=burned_{X}_{Y}
            loop=-1
            x,y={X},{Y}
            sounds=ambient/campfire.ogg
            full_range=10
            fade_range=7
        [/sound_source]    
    #enddef

    [time_area]
        {LIGHT_SCHEDULE 4}
        id=campfire
        x=47,47,48,52,57,53,58,8,5,4
        y=3,4,3,34,32,39,38,30,33,26
    [/time_area]

    {STARTING_VILLAGES_ALL 7}
    {STARTING_VILLAGES 2 7}
    {STARTING_VILLAGES 3 7}
    {STARTING_VILLAGES 4 7}
    {STARTING_VILLAGES 5 3}
    {STARTING_VILLAGES 6 4}

    [side]
        side=1
        controller=human
        gold=200
        {INCOME 5 3 1}
        fog=no
        shroud=no
        share_vision=all
        {BAZUR_ARC_I}
        #recruit=Orcish Grunt,Orcish Archer,Wolf Rider,Goblin Spearman,Troll Whelp
        color=white
        team_name=bazur
        user_team_name= _ "Asheviere's Forces"
        {FLAG_VARIANT ragged}
        save_id=bazur
    [/side]

    [side]
        side=2
        controller=ai
        {GOLD 200 170 130}
        income=15
        fog=no
        shroud=no
        share_vision=all
        {HENRI}
        #recruit=Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Shock Trooper,Mage,Javelineer
        color=darkred
        team_name=bazur
        user_team_name= _ "Asheviere's Forces"
        {FLAG_VARIANT loyalist}
    [/side]

    [side]
        {ASHEVIERE}
        color=red
        side=3
        controller=ai
        canrecruit=yes
        #recruit=Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant
        {GOLD 250 200 170}
        income=10
        team_name=bazur
        user_team_name=_"Asheviere's Forces"
        {FLAG_VARIANT loyalist}
        save_id=queen
    [/side]

    [side]
        color=black
        side=4
        controller=ai
        
        no_leader=yes
        {GOLD 200 170 130}
        income=10
        #recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman
        team_name=bazur
        user_team_name=_"Asheviere's Forces"
        {FLAG_VARIANT ragged}
    [/side]

    [side]
        side=5
        controller=ai
        {GOLD 140 170 200}
        income=10
        fog=no
        shroud=no
        share_vision=all
        {SIR_GREY}
        recruit=Heavy Infantryman,Shock Trooper,Iron Mauler,Peasant,Woodsman
        color=purple
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            grouping=defensive
        [/ai]
    [/side]

    [side]
        side=6
        controller=ai
        {GOLD 140 170 200}
        income=10
        fog=no
        shroud=no
        share_vision=all
        {SIR_ARAN}
        recruit=Horseman,Knight,Lancer,Peasant,Woodsman
        color=blue
        team_name=rebels
        user_team_name= _ "Rebels"
        {FLAG_VARIANT long}
        [ai]
            grouping=defensive
        [/ai]
    [/side]

    [side]
        side=7
        controller=ai
        {GOLD 230 280 340}
        income=10
        fog=no
        shroud=no
        share_vision=all
        type=Ad_Richard
        id=Rebel3
        name=_ "Richard de Ferres"
        [status]
            unslowable=yes
            unpoisonable=yes
        [/status]
        [modifications]
            {TRAIT_HEROIC}
        [/modifications]
        recruit=Swordsman,Pikeman,Javelineer,Halberdier,Spearman,Lieutenant,Sergeant,Royal Guard,Bowman,Longbowman,Peasant,Woodsman
        color=green
        team_name=rebels
        user_team_name= _ "Rebels"
        {FLAG_VARIANT long}
        [ai]
            grouping=defensive
        [/ai]
    [/side]

    {AD_CAPTURE_EVENT 7}
    
    {AD_RECRUIT_EVENT}
    {AD_LOYALS_EVENTS}

    {AD_MARAUDERS}
    {HERODEATH_ACT_I}

    #define IF_HAVE_RECALL SIDE WML

    [if]
    [have_unit]
        role=recall_{SIDE}
        search_recall_list=yes
    [/have_unit]

    {WML}
    [/if]
    #enddef

    [event]
    name=side 3 turn 
    first_time_only=no 

        {IF_HAVE_RECALL 3 (
        [then]
            {MODIFY_UNIT id=Asheviere extra_recruit ""}
        [/then]

        [else]
            [message]
                speaker=Ghuvog 
                message=_ "..."
            [/message]
            {MODIFY_UNIT id=Asheviere extra_recruit "Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant"}
        [/else])}
    [/event]

    [event]
    name=recall
    first_time_only=no 

        [filter]
            side=3
        [/filter]

        {MODIFY_UNIT find_in=unit role ""}

        {IF_HAVE_RECALL 3 (
        [then]
            {MODIFY_UNIT id=Asheviere extra_recruit ""}
        [/then]

        [else]
            [message]
                speaker=Ghuvog 
                message=_ "..."
            [/message]
            {MODIFY_UNIT id=Asheviere extra_recruit "Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant"}
        [/else])}
    [/event]

    [event]
    name=side 4 turn 
    first_time_only=no 

        {IF_HAVE_RECALL 4 (
        [then]
            {MODIFY_UNIT id=Ghuvog extra_recruit ""}
        [/then]

        [else]
            [message]
                speaker=Ghuvog 
                message=_ "..."
            [/message]
            {MODIFY_UNIT id=Ghuvog extra_recruit "Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman"}
        [/else])}
    [/event]

    [event]
    name=recall
    first_time_only=no 

        [filter]
            side=4
        [/filter]

        {MODIFY_UNIT find_in=unit role ""}

        {IF_HAVE_RECALL 4 (
        [then]
            {MODIFY_UNIT id=Ghuvog extra_recruit ""}
        [/then]

        [else]
            [message]
                speaker=Ghuvog 
                message=_ "..."
            [/message]
            {MODIFY_UNIT id=Ghuvog extra_recruit "Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman"}
        [/else])}
    [/event]

    [event]
    name=prestart 

        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [unstore_unit]
            variable=ghuvog 
            x,y=3,30
        [/unstore_unit]

        {MODIFY_UNIT id=Ghuvog side 4}
        {FULL_HEAL id=Ghuvog}

        [foreach]
            array=orc_recalls
            index_var=i 

            [do]
                {VARIABLE this_item.side 4}

                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall 
                [/unstore_unit]
            [/do]
        [/foreach]

        [hide_unit]
            side=1
        [/hide_unit]

        [store_locations]
            terrain=*^Xo
            variable=burning_city
        [/store_locations]

        [foreach]
            array=burning_city
            index_var=i
            [do]
                [item]
                    x=$this_item.x
                    y=$this_item.y
                    halo=scenery/flames[01~15].png:50
                [/item]   
                [time_area]
                    {LIGHT_SCHEDULE 4}
                    id=campfire_$this_item.x_$this_item.y
                    x=$this_item.x
                    y=$this_item.y
                [/time_area]     
                [sound_source]
                    id=burned_$this_item.x_$this_item.y
                    loop=-1
                    x,y=$this_item.x,$this_item.y
                    sounds=ambient/campfire.ogg
                    full_range=10
                    fade_range=7
                [/sound_source]        
            [/do]
        [/foreach]

        {UNIT 3 "Arch Mage" 52 33 (
        id=BattleMage1
        ai_special=guardian 
        )}
        {UNIT 3 "Red Mage" 51 34 (
        id=BattleMage2
        ai_special=guardian 
        )}
        {UNIT 3 "Arch Mage" 55 33 (
        id=BattleMage3
        ai_special=guardian 
        )}
        {UNIT 3 "Red Mage" 56 32 (
        id=BattleMage4
        ai_special=guardian 
        )}

        {UNIT 7 Halberdier 36 8 (ai_special=guardian)}
        {UNIT 7 Halberdier 39 10 (ai_special=guardian)}

        {UNIT 7 Halberdier 49 27 (ai_special=guardian)}
        {UNIT 7 Halberdier 46 28 (ai_special=guardian)}

        {UNIT 7 Halberdier 18 23 (ai_special=guardian)}
        {UNIT 7 Halberdier 15 22 (ai_special=guardian)}

        {UNIT 7 "Master Bowman" 18 15 (ai_special=guardian)}
        {UNIT 7 "Master Bowman" 20 12 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 19 15 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 20 13 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 17 16 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 20 11 (ai_special=guardian)}
        {UNIT 7 "Halberdier" 15 16 (ai_special=guardian)}
        {UNIT 7 "Halberdier" 19 10 (ai_special=guardian)}

        {UNIT 5 "Pikeman" 32 30 (ai_special=guardian)}
        {UNIT 5 "Longbowman" 26 25 (ai_special=guardian)}

        {UNIT 6 "Swordsman" 43 18 (ai_special=guardian)}
        {UNIT 6 "Javelineer" 36 14 (ai_special=guardian)}

        {UNIT 5 "Spearman" 35 19 (ai_special=guardian)}

        {MODIFY_AI_ADD_GOAL 2 (
            [goal]
                id=target_2
                name=target_location
                [criteria]
                    x,y=39,8
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 3 (
            [goal]
                id=target_3
                name=target_location
                [criteria]
                    x,y=49,29
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 4 (
            [goal]
                id=target_4
                name=target_location
                [criteria]
                    x,y=15,24
                [/criteria]
                value=50
            [/goal]
        )}
    [/event]

    [event]
    name=start 

        [delay]
            time=300
        [/delay]

        {REMOVE_IMAGE 32 20}

        {PLACE_IMAGE scenery/trapdoor-open.png 32 20}

        [sound]
            name=mace-miss.ogg 
        [/sound]

        [delay]
            time=300
        [/delay]

        [unhide_unit]
            side=1
        [/unhide_unit]

        {MOVE_UNIT id=Bazur 31 20}

        [recall]
            id=Isolde 
            x,y=32,20
            animate=no
        [/recall]

        {MOVE_UNIT id=Isolde 33 20}

        [recall]
            side=1
            x,y=32,20
            animate=no
        [/recall]

        {MOVE_UNIT x,y=32,20 32 21}

        [if]
        [variable]
            name=save_chu 
            numerical_equals=1
        [/variable]

        [then]

        {REPEAT 6 (

        [recall]
            side=1
            race=monster
            x,y=32,20
            animate=yes
        [/recall])}

        [/then]

        [/if]

        [message]
            speaker=Bazur 
            message=_ "What a load of rubbish!!!"
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Keep shelling the city. Let the rebel fortifications be reduced to ashes."
        [/message]

        [message]
            speaker=BattleMage1
            message=_ "Your Highness, it would be wiser to take the city rather than wipe it out."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Either you do your job or you take the city going straight to the walls."
        [/message]

        {FIREBALL BattleMage1 37 18}

        [delay]
            time=300
        [/delay]

        {FIREBALL BattleMage4 32 27}

        [message]
            speaker=Rebel1
            message=_ "The royal mages are destroying the city! What do we do?"
        [/message]

        [message]
            speaker=Rebel3
            message=_ "When we had everything we needed to win, you refused to recognise me as king and argued endlessly in the damned council of lords. And now, with half the council in the grave and Dan-Tonk surrounded, you ask me what to do?! Fight to the last man, that's what we do. If we hold out, the armies of Elensefar and Aethenwood will join us. With them, we will crush Asheviere and then I will be king. Any objections?"
        [/message]
        
        [message]
            speaker=Rebel2
            message=_ "No, the games of democracy have indeed cost us too much."
        [/message]

        [message]
            speaker=Rebel3
            message=_ "Then let's do it! Let's show these mutts we still have Garard's spirit in us!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "We must break through to the gates and open them to the Queen's army immediately or we will be crushed. Let's go!"
        [/message]

        {PLACE_IMAGE items/gohere.png 37 9}

        [scroll_to]
            x,y=37,9
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 47 28}

        [scroll_to]
            x,y=47,28
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 17 23}

        [scroll_to]
            x,y=17,23
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        [terrain]
            x,y=32,20
            radius=1
            terrain=^Cov
            layer=overlay
        [/terrain]

        [terrain]
            x,y=32,20
            terrain=^Kov
            layer=overlay
        [/terrain]

        [store_locations]
            terrain=*^Cov
            variable=castle
        [/store_locations]

        [foreach]
            array=castle
            index_var=i
            [do]
                [item]
                    x=$this_item.x
                    y=$this_item.y
                    image="items/gohere-empty.png"
                [/item]        
            [/do]
        [/foreach]

        [objectives]
            silent=no
                [objective]
                    description= _ "Move any unit to the hex marked in front of the gate to open it for allies"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Defeat the rebel leaders"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Bazur"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Isolde"
                    condition=lose
                [/objective]
                {IS_LAST_SCENARIO}
                [note]
                    description=_ "The hex with the trapdoor works as a citadel, and the marked hexes around it work as a castle."
                [/note]
        [/objectives]   
    [/event]

    [event]
    name=turn 2

        {FIREBALL BattleMage1 44 14}
        {FIREBALL BattleMage4 22 14}

    [/event]
    [event]
    name=turn 3

        {FIREBALL BattleMage2 32 31}
        {FIREBALL BattleMage3 20 13}

    [/event]
    [event]
    name=turn 4

        {FIREBALL BattleMage2 17 16}
        {FIREBALL BattleMage3 41 14}

    [/event]

    #define CHECK_GATES

        [if]
            [variable]
                name=unit.race 
                equals=human 
            [/variable]
        [then]
            {VARIABLE_OP gates_human add 1}

            [if]
                [variable]
                    name=gates_human 
                    numerical_equals=3
                [/variable]
            [then]
                [set_achievement]
                    content_for=AD_Achievements
                    id=AD_S7_Offical
                [/set_achievement]
            [/then]
            [/if]
        [/then]
        [/if]
    #enddef

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=17,23
            [/filter_location]
        [/filter] 

        {REMOVE_IMAGE 17 23}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=15,16,17
            y=23,23,24
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=4
            action=delete
            path=goal[target_4]
        [/modify_ai]

        [message]
            side=4
            canrecruit=yes
            message=_ "Let's go, freaks! We'll have fun in the streets!"
        [/message]

        {CHECK_GATES}

    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=47,28
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 47 28}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=47,48,49
            y=29,28,28
            terrain=Rr^Pr/o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=3
            action=delete
            path=goal[target_3]
        [/modify_ai]

        [message]
            speaker=Asheviere
            message=_ "It's just as I planned. Enter the city and clear it of rebels, soldiers."
        [/message]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=37,9
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 37 9}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=37,38,39
            y=8,8,9
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=2
            action=delete
            path=goal[target_2]
        [/modify_ai]

        [message]
            side=2
            canrecruit=yes
            message=_ "Looks like I was right with Isolde and that orc. The gates are open! Rush!"
        [/message]

        {CHECK_GATES}
    [/event]

    [event]
    name=enemies_defeated 
	[transform_unit]
		id=Delfador
		transform_to=Elder Mage
	[/transform_unit]
	[remove_object]
            id=Delfador
            object_id=halo_delfador
        [/remove_object]
        [message]
            speaker=Bazur
            message=_ "All the big bumps have been smashed! We won this mess!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "I find that hard to believe... I hope there won't be any more bloody battles between humans in Wesnoth."
        [/message]

        [message]
            speaker=Delfador
            message=_ "Ah, stubborn Richard lost it all. Wesnoth definitely needs a new ruler, but I don't see anyone here who fits that role. I guess I'll have to employ a backup plan..."
        [/message]

        [animate_unit]
            flag=escape_teleport
            [filter]
                id=Delfador
            [/filter]
        [/animate_unit]

        [kill]
            id=Delfador 
            animate=no 
        [/kill]

        [message]
            speaker=Bazur
            message=_ "Your fabled Delfador is gone. "
        [/message]

        [message]
            speaker=Isolde
            message=_ "He fancies himself a great mage capable of sealing the fate of Wesnoth, but as far as I'm concerned, he's just a deceiver and a schemer. And that's a good thing. We'd be in trouble if he was brave enough to take part in every big battle of the rebels."
        [/message]

        [message]
            speaker=Bazur
            message=_ "It's not fair that a sneaky worm has that kind of power. I hope one day I slit his throat."
        [/message]

        [message]
            sound=horn-signals/horn-7.ogg
            speaker=Isolde
            message=_ "That would be nice... You hear that, trumpets? It sounds like the Queen is entering the city..."
        [/message]
        
        [hide_unit]
            side=1,2,3,4,5,6,7
        [/hide_unit]

        {FADE_TO_BLACK}

        {REMOVE_IMAGE 32 20}
        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [store_locations]
            terrain=*^Cov
            variable=castle
        [/store_locations]

        [foreach]
            array=castle
            index_var=i
            [do]
                {REMOVE_IMAGE $this_item.x $this_item.y}
            [/do]
        [/foreach]

        [kill]
            side=2,3,4,5,6,7
            canrecruit=no 
        [/kill]

        [put_to_recall_list]
            side=1
            canrecruit=no 
            [not]
                id=Isolde 
            [/not]
        [/put_to_recall_list]

        {TELEPORT_UNIT id=Bazur 31 19}
        {TELEPORT_UNIT id=Isolde 30 19}
        {TELEPORT_UNIT id=General_Ally 30 20}
        {TELEPORT_UNIT id=Warlord_Ally 33 19}

        [modify_unit]
            [filter]
                race=orc,human 
            [/filter]
            facing=s
        [/modify_unit]

        [scroll_to]
            x,y=32,20 
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {CAPTURE_VILLAGES 3 32 20 100}

        {FADE_IN}

        [unhide_unit]
            side=1,2,3,4
        [/unhide_unit]

        {REPLACE_SCENARIO_MUSIC main_menu.ogg}

        {UNIT 3 "Royal Guard" 49 29 (id=guard1)}
        {MOVE_UNIT id=guard1 48 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard2)}
        {MOVE_UNIT id=guard2 46 28}

        {UNIT 3 "Royal Guard" 49 29 (id=guard3)}
        {MOVE_UNIT id=guard3 45 26}

        {UNIT 3 "Royal Guard" 49 29 (id=guard4)}
        {MOVE_UNIT id=guard4 43 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard5)}
        {MOVE_UNIT id=guard5 42 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard6)}
        {MOVE_UNIT id=guard6 40 25}

        {UNIT 3 "Royal Guard" 49 29 (id=guard8)}
        {MOVE_UNIT id=guard8 39 23}

        {UNIT 3 "Royal Guard" 49 29 (id=guard9)}
        {MOVE_UNIT id=guard9 37 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard10)}
        {MOVE_UNIT id=guard10 36 21}

        {UNIT 3 "Royal Guard" 49 29 (id=guard11)}
        {MOVE_UNIT id=guard11 34 22}

        {TELEPORT_UNIT id=Asheviere 49 29}
        {MOVE_UNIT id=Asheviere 35 22}

        [scroll_to]
            x,y=32,20
        [/scroll_to]

        [message]
            speaker=Asheviere 
            message=_ "The rebel leaders are crushed, the rebel capital lies at my feet. To whom do I owe this glittering triumph?"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Me!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "(punching Bazur in the side) Quiet, you."
        [/message]

        [message]
            speaker=General_Ally
            message=_ "We were merely carrying out Your Majesty's orders."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "That's right. I wish I could see Garard's face now. It seems I have not failed him in the art of war."
        [/message]

        [message]
            speaker=General_Ally
            message=_ "Absolutely not, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "However, even the most competent order will be useless if there are no worthy executors for it. I am glad that I have just such people at hand."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Isolde, you have served me well. And as I see, you were able to train a band of orcs. Not everyone even among my loyal generals is capable of doing so. For the brilliant execution of my orders, I will confirm your knighthood, as promised. Do you wish to continue your service, or will you return to the manor to rebuild the family nest you have longed for?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "I... I will continue to serve Your Grace until She herself deems my duty done."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "That's great. Keep it up, and pretty soon the crown won't have any problems that require your presence."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "General Henri; frankly, I doubted you at first, for you were one of Garard's closest men; but you have proven yourself loyal to the crown, not to a person, and I have appreciated that. I promote you to Grand Marshal; lead my armies and cleanse Wesnoth of the remnants of the rebel plague that no doubt still lurk in the darkest and dirtiest corners of my kingdom."
        [/message]

        {TRANSFORM_UNIT id=General_Ally "Grand Marshal"}

        [message]
            speaker=General_Ally
            message=_ "I serve Wesnoth, Your Majesty!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Finally, an orc. What was his name again?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "His name is Bazur, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Ah, yes, Bazur. You've been one of the best orcs to enter my service; you've obeyed orders faithfully, and you've been the least likely to abuse my favour. I will make your band my personal guard. You will come with me to Weldyn, where you will receive a proper welcome and be armed with the best of my armoury."
        [/message]
        
        [message]
            speaker=Bazur
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I'll pretend I didn't notice the behaviour and there's another chance for you to respond appropriately."
        [/message]

        [message]
            speaker=Bazur
            message=_ "I serve you, Your Majesty!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "That'll do. Vashna, though you may not have served as well as Bazur, I appreciate the contribution your warband made to the siege of Dan-Tonk and will pay you five times what I promised. May this gold motivate you to new feats."
        [/message]

        [message]
            speaker=Warlord_Ally
            message=_ "We will fight for Your Majesty like never before."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "That's great. Marshal Henri, has Dan-Tonk's citadel survived?"
        [/message]

        [message]
            speaker=General_Ally
            message=_ "That's right, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Then I'll have a feast there in honour of our victory. You are all invited."
        [/message]

        [message]
            speaker=General_Ally
            message=_ "Hurrah for Your Majesty!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Warlord_Ally
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "HURRA-A-A-AH!"
        [/message]

        [endlevel]
            linger_mode=no
            result=victory 
            bonus=yes 
            carryover_add=yes 
            carryover_percentage=40 
            end_text=_ "To be continued..."
        [/endlevel]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Rebel1 
        [/filter] 

        [message]
            speaker=unit 
            message=_ "This riot was a mistake... mercy!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You had a chance to surrender at Weldyn."
        [/message]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Rebel2
        [/filter] 

        [message]
            speaker=unit 
            message=_ "Is this really the end?"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "This is the end of your rebellion, and the beginning of my long and peaceful reign."
        [/message]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Rebel3
        [/filter] 

        [message]
            speaker=unit 
            message=_ "Argh, idiots, all because of those idiots. Garard weeps seeing you from his grave, you cowards!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You've always annoyed me. Go to your grave, straight to my drunken husband, whom you adored so much."
        [/message]
    [/event]

    [event]
    name=turn 5
    first_time_only=yes

        [if]

        [have_unit]
            id=Rebel3 
        [/have_unit]

        [then]

        [unit]
            id=Delfador
            name= _ "Delfador"
            side=7
            profile=portraits/delfador.webp
            unrenamable=yes
            type=AD Fog Clearer
            hidden=yes
            facing=se
            x,y=5,7
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_INTELLIGENT}
                [object]
                    [effect]
                        apply_to=new_animation
                        [extra_anim]
                            flag=escape_teleport
                            start_time=-1200

                            teleport_sparkle_1_start_time=-1200
                            teleport_sparkle_2_start_time=-1000
                            teleport_sparkle_3_start_time=-800

                            [teleport_sparkle_1_frame]
                                duration=800
                                halo=halo/teleport-[9,8,1~9].png
                                halo_x=-10
                                halo_y=30~-30
                            [/teleport_sparkle_1_frame]
                            [teleport_sparkle_2_frame]
                                duration=800
                                halo=halo/teleport-[9,8,1~9].png
                                halo_x=0
                                halo_y=40~-40
                            [/teleport_sparkle_2_frame]
                            [teleport_sparkle_3_frame]
                                duration=800
                                halo=halo/teleport-[9,8,1~9].png
                                halo_x=10
                                halo_y=30~-30
                            [/teleport_sparkle_3_frame]
                            
				[frame]
                                image="units/human-magi/elder-mage-ranged1.png:[200,100*7]"
                             [/frame]

                            [frame]
                                image="misc/blank-hex.png:300"
                            [/frame]
                        [/extra_anim]
                        [extra_anim]
                            flag=intro_teleport
                            start_time=-1200

                            teleport_sparkle_1_start_time=-1200
                            teleport_sparkle_2_start_time=-1000
                            teleport_sparkle_3_start_time=-800

                            [teleport_sparkle_1_frame]
                                duration=800
                                halo=halo/teleport-[9,8,1~9].png
                                halo_x=-10
                                halo_y=30~-30
                            [/teleport_sparkle_1_frame]
                            [teleport_sparkle_2_frame]
                                duration=800
                                halo=halo/teleport-[9,8,1~9].png
                                halo_x=0
                                halo_y=40~-40
                            [/teleport_sparkle_2_frame]
                            [teleport_sparkle_3_frame]
                                duration=800
                                halo=halo/teleport-[9,8,1~9].png
                                halo_x=10
                                halo_y=30~-30
                            [/teleport_sparkle_3_frame]

                            [frame]
                                image="misc/blank-hex.png:300"
                            [/frame]
                        [/extra_anim]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unhide_unit]
            id=Delfador 
        [/unhide_unit]

        [animate_unit]
            flag=intro_teleport
            [filter]
                id=Delfador
            [/filter]
        [/animate_unit]
        
        [transform_unit]
        	id=Delfador
        	transform_to=Elder Mage
        [/transform_unit]

        [message]
            speaker=Delfador 
            message=_ "Looks like I'm not too late. Good, then there's still hope for us. "
        [/message]

        [message]
            speaker=Rebel3
            message=_ "Delfador, damn it! Where have you been since the battle of Tath? We've needed your help so many times, and you seem to have cowardly run away."
        [/message]

        [message]
            speaker=Delfador 
            message=_ "Forgive my disappearance, Baron Richard, I assure you there were valid reasons. How many troops are left in our disposition?"
        [/message]

        [message]
            speaker=Rebel3
            message=_ "First of all, in my possession. And secondly, you are one of them and you must obey me as Garard's chief successor. Come on, use all your magic on the royal dogs and help us hold the city!"
        [/message]

        [message]
            image=portraits/delfador-mentoring.webp
            speaker=Delfador 
            message=_ "This defense is doomed to fail; the city is surrounded, Asheviere has thousands of orcs at her hand, while we have no one to replace the fallen soldiers. I have another plan, Baron. I can open a portal to get our troops out..."
        [/message]

        [message]
            speaker=Rebel3
            message=_ "...I'm not running anywhere!"
        [/message]

        [message]
            image=portraits/delfador-mentoring.webp
            speaker=Delfador 
            message=_ "...The Elves of Aethenwood are on our side, I've negotiated their support. Elensefar will follow. The key now is to preserve the remnants of our army and you as a contender for the throne... "
        [/message]

        [message]
            speaker=Rebel3
            message=_ "Can't you hear me? I'm not running from Asheviere's mutts in my own town. It is because of men like you, who love to play intrigue and politics, that we are besieged in our own domain. Real business is done here and now, on the battlefield. If the elves of Aethenwood support me, they must bring an army here immediately. If you support me, you must join the battle. Otherwise, these are empty words that only distract us from the cause."
        [/message]

        [message]
            speaker=Delfador 
            message=_ "(<i>Oh, he's as hard-headed as Garard.</i>) Richard, if you lose your entire army in this battle, or even more so if you die yourself, the whole cause is lost."
        [/message]

        [message]
            speaker=Rebel3
            message=_ "The case was lost when we made a rant instead of going to Weldyn. I'm done talking! Help me defend the city, or get out of my sight."
        [/message]

        [message]
            speaker=Delfador 
            message=_ "Whatever you say, Baron. I'll try to tip the scales in our favor. "
        [/message]

        {FLASH_BLUE (
        [sound]
            name=lightning.ogg
        [/sound]
        )} 

        [terrain]
            x,y=5,7
            radius=1
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=5,7
            terrain=Gg
        [/terrain]

        [terrain]
            x,y=7,7
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=5,9
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=3,6
            terrain=Qxua^Es 
        [/terrain]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Asheviere
            message=_ "Delfador, my husband's sneaky henchman. I'm surprised you had the courage to come here. You won't get away from me this time."
        [/message]

        [message]
            speaker=Bazur
            message=_ "Who the hell is Delfador?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "A court mage who, by the way, outsmarted orcs and lizards and had you fighting each other. "
        [/message]

        [message]
            speaker=Bazur
            message=_ "That rascal! Then I must get him!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Don't talk nonsense, even if we make it outside the city, the Queen will see it as a betrayal. Focus on the gates and the rebel commanders... And be prepared for the sky to fall on us soon..."
        [/message]
        
        [object]
        	id=halo_delfador
            take_only_once=no
            duration=forever
            [filter]
                id=Delfador
            [/filter]
            [effect]
		    apply_to=halo
		    halo="halo/ring-[1~3].png:100"
		[/effect]
        [/object]
        
        [transform_unit]
        	id=Delfador
        	transform_to=AD Delfador Casting
        [/transform_unit]

        [event]
        name=first_light
        first_time_only=yes 

            [message]
                speaker=Delfador
                image=portraits/delfador-mad.webp
                message=_ "I will unleash the full force of the storm upon you for betraying Garard!"
            [/message]

        [/event]


        [event]
        name=new_turn 
        first_time_only=no 

            [fire_event]
                name=first_light
            [/fire_event]

            {REPEAT {ON_DIFFICULTY 4 5 6} (

            [store_unit]
                [filter]
                    side=2,3,4
                    canrecruit=no 
                [/filter]
                kill=no 
                variable=target 
            [/store_unit]

            {VARIABLE target_random_limit $target.length}
            {VARIABLE_OP target_random_limit sub 1}
            {RANDOM 0..$target_random_limit}

            [object]
				id=struck_by_lightning
           	 	take_only_once=no
            	duration=turn
                silent=yes
                [filter]
                    id=$target[$random].id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=struck_by_lightning
                    range=ranged
                    damage=0
                    attacks=0
                    type=fire
                [/effect]
                [effect]
                    apply_to=new_animation
                    id=struck_by_lightning

                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-1-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-1-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-1-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-1-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-2-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-2-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-2-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-2-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-3-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-3-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-3-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=100
                            halo=halo/lightning-bolt-3-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                [/effect]
            [/object]

            {MODIFY_UNIT id=$target[$random].id facing n}

            [sound]
                name=lightning.ogg 
            [/sound]

            [animate_unit]
                flag=attack
                [filter]
                    id=$target[$random].id
                [/filter]
                [primary_attack]
                    name=struck_by_lightning
                [/primary_attack]
                hits=yes
            [/animate_unit]

            [harm_unit]
			    [filter]
                    id=$target[$random].id
			    [/filter]
			    amount=14
			    damage_type=fire
			    slowed=no
			    fire_event=yes
			    experience=no
			    kill=yes
			    animate=yes
		    [/harm_unit]

            [remove_object]
                id=$target[$random].id
                object_id=struck_by_lightning
            [/remove_object]
            
            {CLEAR_VARIABLE target}
            )}

        [/event]
        [/then]

        [else]
        [/else]
        [/if]
    [/event]

    [event]
    name=die 

        [filter]
            id=Rebel3 
        [/filter]

        [filter_attack_second]
            type=blade,pierce 
            range=ranged 
        [/filter_attack_second]

        [set_achievement]
            content_for=AD_Achievements
            id=AD_S7_Armour
        [/set_achievement]
    [/event]
[/scenario]
