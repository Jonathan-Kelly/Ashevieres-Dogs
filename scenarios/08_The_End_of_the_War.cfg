#textdomain wesnoth-AD

[scenario]
    id=08_The_End_of_the_War
    name= _ "The End of the War"
    map_data="{~add-ons/Ashievieres_Dogs/maps/08_The_End_of_the_War.map}"

    [event]
    name=prestart,new_turn
    first_time_only=no

        {LIGHT_EFFECT "*^Ecf"}
    [/event] 

    [event]
    name=prestart

        {PLACE_FIRE 36 23}
        {PLACE_FIRE 31 33}
        {PLACE_FIRE 25 22}
        {PLACE_FIRE 34 9}
        {PLACE_FIRE 19 19}
    [/event]

    {IMPLEMENT_FIRES}

    turns=-1
    next_scenario=null
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes
    current_time=4

    {DEFAULT_SCHEDULE}

    {SCENARIO_MUSIC "battle-epic.ogg"}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_city_falls.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
    {EXTRA_SCENARIO_MUSIC "northern_mountains.ogg"}

    {AD_TRACK {JOURNEY_07_NEW} }

    [label]
        x,y=38,8
        text=_ "Northern gates"
        immutable=yes
    [/label]

    [label]
        x,y=48,28
        text=_ "Eastern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,23
        text=_ "Southern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,12
        text=_ "Dan-Tonk citadel"
        immutable=yes
    [/label]

    #define FIREBALL MAGE_ID X Y

        [animate_unit]
            flag=attack
                [filter]
                    id={MAGE_ID}
                [/filter]
                [facing]
                    x,y=15,12
                [/facing]
                [primary_attack]
                    range=ranged
                    type=fire
                [/primary_attack]
            hits=yes
        [/animate_unit]

        [scroll_to]
            x,y={X},{Y}
        [/scroll_to]

        {QUAKE "explosion.ogg"}
        {QUAKE "rumble.ogg"}
        {QUAKE "cave-in.ogg"}

        [item]
            halo="data/add-ons/Ashievieres_Dogs/images/projectiles/fireball-impact-[1~17].png"
            x={X}
            y={Y}
        [/item]

        [delay]
            time=900
        [/delay]

        [harm_unit]
            [filter]
                [filter_location]
                    x,y={X},{Y}
                [/filter_location]
            [/filter]
            damage_type=fire
            amount=25
            kill=yes
            fire_event=yes
            animate=no
            experience=no
        [/harm_unit]

        {REMOVE_IMAGE {X} {Y}}

        {PLACE_FIRE {X} {Y}}    
    #enddef

    {STARTING_VILLAGES_ALL 7}

    {STARTING_VILLAGES 2 12}
    {STARTING_VILLAGES 3 12}
    {STARTING_VILLAGES 4 6}

    {STARTING_VILLAGES_AREA 5 32 27 8}
    {STARTING_VILLAGES_AREA 6 40 16 8}
   

    [event]
    name=prestart 

        [capture_village]
            side=2
            x=57,57,32,13,7,39
            y=14,9,4,7,10,4
        [/capture_village]

        [capture_village]
            side=3
            x=36,29
            y=44,43
        [/capture_village]

        [capture_village]
            side=4
            x=6,12,5,19
            y=40,35,22,42
        [/capture_village]
    [/event]

    [side]
        side=1
        controller=human
        gold=200
        {INCOME 5 3 1}
        fog=no
        shroud=no
        share_vision=all
        {BAZUR_ARC_I}
        color=white
        team_name=bazur
        user_team_name= _ "Asheviere's Forces"
        {FLAG_VARIANT ragged}
        save_id=bazur
    [/side]

    [side]
        side=2
        controller=ai
        gold=185
        income=15
        fog=no
        shroud=no
        share_vision=all
        {HENRI}
        recruit=Spearman,Pikeman,Javelineer,Bowman,Longbowman,Shock Trooper,Mage,Dragoon,Fencer,Cavalryman
        color=darkred
        team_name=bazur
        user_team_name= _ "Asheviere's Forces"
        {FLAG_VARIANT loyalist}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            recruitment_pattern=fighter,fighter,archer 
        [/ai]
    [/side]

    [side]
        {ASHEVIERE}
        color=red
        side=3
        controller=ai
        canrecruit=yes
        recruit=Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant
        gold=185
        income=15
        team_name=bazur
        user_team_name=_"Asheviere's Forces"
        {FLAG_VARIANT loyalist}
        save_id=queen
        [ai]
            {NO_SCOUTS}
            aggression=0.88
        [/ai]
    [/side]

    [side]
        defeat_condition=never
        color=black
        side=4
        controller=ai
        
        no_leader=yes
        gold=185
        income=15
        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman
        team_name=bazur
        user_team_name=_"Asheviere's Forces"
        {FLAG_VARIANT ragged}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        {GOLD 100 200 250}
        income=10
        fog=no
        shroud=no
        share_vision=all
        {SIR_GREY}
        recruit=Heavy Infantryman,Shock Trooper,Iron Mauler,Peasant,Woodsman
        color=purple
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping={ON_DIFFICULTY defensive offensive no}
        [/ai]
    [/side]

    [side]
        side=6
        controller=ai
        {GOLD 100 200 250}
        income=10
        fog=no
        shroud=no
        share_vision=all
        {SIR_ARAN}
        recruit=Horseman,Knight,Lancer,Peasant,Woodsman
        color=blue
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping={ON_DIFFICULTY defensive offensive no}
        [/ai]
    [/side]

    [side]
        side=7
        controller=ai
        {GOLD 200 300 400}
        income=10
        fog=no
        shroud=no
        share_vision=all
        {BARON_RICHARD}
        recruit=Swordsman,Pikeman,Javelineer,Halberdier,Spearman,Lieutenant,Sergeant,Royal Guard,Bowman,Longbowman,Peasant,Woodsman
        color=green
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping={ON_DIFFICULTY defensive offensive no}
        [/ai]
    [/side]

    {PEASANT_SIDE 8}
    {AD_CAPTURE_EVENT 8}
    
    {AD_RECRUIT_EVENT}
    {AD_LOYALS_EVENTS}

    {AD_MARAUDERS}
    {HERODEATH_ACT_I}

    #define IF_HAVE_RECALL SIDE WML

    [if]
    [have_unit]
        role=recall_{SIDE}
        search_recall_list=yes
    [/have_unit]

    {WML}
    [/if]
    #enddef

    [event]
    name=side 3 turn 
    first_time_only=no 

        {IF_HAVE_RECALL 3 (
        [then]
            {MODIFY_UNIT id=Asheviere extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Asheviere extra_recruit "Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant"}
        [/else])}
    [/event]

    [event]
    name=recall
    first_time_only=no 

        [filter]
            side=3
        [/filter]

        {MODIFY_UNIT find_in=unit role ""}

        {IF_HAVE_RECALL 3 (
        [then]
            {MODIFY_UNIT id=Asheviere extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Asheviere extra_recruit "Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant"}
        [/else])}
    [/event]

    [event]
    name=side 4 turn 
    first_time_only=no 

        {IF_HAVE_RECALL 4 (
        [then]
            {MODIFY_UNIT id=Ghuvog extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Ghuvog extra_recruit "Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman"}
        [/else])}
    [/event]

    [event]
    name=recall
    first_time_only=no 

        [filter]
            side=4
        [/filter]

        {MODIFY_UNIT find_in=unit role ""}

        {IF_HAVE_RECALL 4 (
        [then]
            {MODIFY_UNIT id=Ghuvog extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Ghuvog extra_recruit "Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman"}
        [/else])}
    [/event]

    [event]
    name=prestart 

        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [unstore_unit]
            variable=ghuvog 
            x,y=3,30
        [/unstore_unit]

        {MODIFY_UNIT id=Ghuvog side 4}
        {FULL_HEAL id=Ghuvog}

        [foreach]
            array=orc_recalls
            index_var=i 

            [do]
                {VARIABLE this_item.side 4}

                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall 
                [/unstore_unit]
            [/do]
        [/foreach]

        [hide_unit]
            side=1
        [/hide_unit]

        {UNIT 3 "Arch Mage" 50 35 (
        id=BattleMage1
        ai_special=guardian 
        )}
        {UNIT 3 "Red Mage" 51 35 (
        id=BattleMage2
        ai_special=guardian 
        )}
        {UNIT 3 "Arch Mage" 53 34 (
        id=BattleMage3
        ai_special=guardian 
        )}
        {UNIT 3 "Red Mage" 54 33 (
        id=BattleMage4
        ai_special=guardian 
        )}

        {UNIT 7 Halberdier 36 8 (ai_special=guardian)}
        {UNIT 7 Halberdier 39 10 (ai_special=guardian)}

        {UNIT 7 Halberdier 49 27 (ai_special=guardian)}
        {UNIT 7 Halberdier 46 28 (ai_special=guardian)}

        {UNIT 7 Halberdier 18 23 (ai_special=guardian)}
        {UNIT 7 Halberdier 15 22 (ai_special=guardian)}

        {UNIT 7 "Master Bowman" 18 15 (ai_special=guardian)}
        {UNIT 7 "Master Bowman" 20 12 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 19 15 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 20 13 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 17 16 (ai_special=guardian)}
        {UNIT 7 "Iron Mauler" 20 11 (ai_special=guardian)}
        {UNIT 7 "Halberdier" 15 16 (ai_special=guardian)}
        {UNIT 7 "Halberdier" 19 10 (ai_special=guardian)}

        {MODIFY_AI_ADD_GOAL 2 (
            [goal]
                id=target_2
                name=target_location
                [criteria]
                    x,y=39,8
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 3 (
            [goal]
                id=target_3
                name=target_location
                [criteria]
                    x,y=49,29
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 4 (
            [goal]
                id=target_4
                name=target_location
                [criteria]
                    x,y=15,24
                [/criteria]
                value=50
            [/goal]
        )}
    [/event]

    [event]
    name=start 

        [delay]
            time=300
        [/delay]

        {REMOVE_IMAGE 32 20}

        {PLACE_IMAGE scenery/trapdoor-open.png 32 20}

        [sound]
            name=mace-miss.ogg 
        [/sound]

        [delay]
            time=300
        [/delay]

        [unhide_unit]
            side=1
        [/unhide_unit]

        {MOVE_UNIT id=Bazur 31 20}

        [recall]
            id=Isolde 
            x,y=32,20
            animate=no
        [/recall]

        {MOVE_UNIT id=Isolde 33 20}

        [if]
            [have_unit]
                id=Ron 
                side=1
            [/have_unit]
        [then]

            [recall]
                id=Ron
                x,y=32,20
                animate=no
            [/recall]

            {MOVE_UNIT x,y=32,20 32 21}
        [/then]

        [else]
            [recall]
                side=1
                x,y=32,20
                animate=no
            [/recall]

            {MOVE_UNIT x,y=32,20 32 21}
        [/else]
        [/if]

        [if]
        [variable]
            name=save_chu 
            numerical_equals=1
        [/variable]

        [then]

        {REPEAT 6 (

        [recall]
            side=1
            race=monster
            x,y=32,20
            animate=yes
        [/recall])}

        [/then]

        [/if]

        [message]
            speaker=Bazur 
            message=_ "Whoa, what a blast!!!"
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Keep shelling the city, I want the rebel walls turned to dust before my warriors storm the city."
        [/message]

        [message]
            speaker=BattleMage1
            message=_ "Your Majesty, our goal is not to destroy the city, but to capture it."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Do as you're told, or you're going to capture it yourself, in the front lines!"
        [/message]

        [message]
            speaker=BattleMage1
            message=_ "(I never thought I'd live until this moment!)"
        [/message]

        {FIREBALL BattleMage1 37 18}

        [delay]
            time=300
        [/delay]

        {FIREBALL BattleMage4 32 27}

        [message]
            speaker=Sir_Aran
            message=_ "The royal mages are bombarding the city! De Ferres, what do we do?"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "At the battle of Weldyn you did not ask me what to do, Aran, but now you speak! I'll tell you what to do: defend Dan-Tonk to the last drop of blood, be the rock against which the Ashevir horde will break their teeth! They will tear themselves apart, they will run, and on their shoulders we will enter Veldin, and you will recognize me as king! Any objections?"
        [/message]
        
        [message]
            speaker=Sir_Aran
            message=_ "Not at all, my King!"
        [/message]

        [message]
            speaker=Sir_Grey
            message=_ "There's no turning back, to Weldyn or to the grave, I'm with you, Richard!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "On the walls, then! Let's show these scum that the spirit of Garard lives!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "We must break through to the gates and open them to the royal army at once, or we will be crushed!"
        [/message]

        {PLACE_IMAGE items/gohere.png 37 9}

        [scroll_to]
            x,y=37,9
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 47 28}

        [scroll_to]
            x,y=47,28
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 17 23}

        [scroll_to]
            x,y=17,23
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        [terrain]
            x,y=32,20
            radius=1
            terrain=^Cov
            layer=overlay
        [/terrain]

        [terrain]
            x,y=32,20
            terrain=^Kov
            layer=overlay
        [/terrain]

        [store_locations]
            terrain=*^Cov
            variable=castle
        [/store_locations]

        [foreach]
            array=castle
            index_var=i
            [do]
                [item]
                    x=$this_item.x
                    y=$this_item.y
                    image="items/gohere-empty.png"
                [/item]        
            [/do]
        [/foreach]

        [objectives]
            silent=no
                [objective]
                    description= _ "Move any unit to the hex marked in front of the gate to open it for allies"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Defeat the rebel leaders"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Bazur"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Isolde"
                    condition=lose
                [/objective]
                {IS_LAST_SCENARIO}
                [note]
                    description=_ "The hex with the trapdoor works as a citadel, and the marked hexes around it work as a castle."
                [/note]
        [/objectives]   
    [/event]

    [event]
    name=turn 2

        {FIREBALL BattleMage1 44 14}
        {FIREBALL BattleMage4 22 14}
    [/event]

    [event]
    name=turn 3

        {FIREBALL BattleMage2 32 31}
        {FIREBALL BattleMage3 20 13}
    [/event]

    [event]
    name=turn 4
        {FIREBALL BattleMage2 17 16}
        {FIREBALL BattleMage3 41 14}
    [/event]

    [event]
    name=turn 5
        {FIREBALL BattleMage1 23 21}
        {FIREBALL BattleMage4 39 15}
    [/event]

    [event]
    name=turn 5
        {FIREBALL BattleMage1 29 12}
        {FIREBALL BattleMage4 21 12}
    [/event]

    #define CHECK_GATES

        [if]
            [variable]
                name=unit.race 
                equals=human 
            [/variable]
        [then]
            {VARIABLE_OP gates_human add 1}

            [if]
                [variable]
                    name=gates_human 
                    numerical_equals=3
                [/variable]
            [then]
                [set_achievement]
                    content_for=AD_Achievements
                    id=AD_S7_Offical
                [/set_achievement]
            [/then]
            [/if]
        [/then]
        [/if]
    #enddef

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=17,23
            [/filter_location]
        [/filter] 

        {REMOVE_IMAGE 17 23}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=15,16,17
            y=23,23,24
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=4
            action=delete
            path=goal[target_4]
        [/modify_ai]

        [message]
            speaker=Ghuvog
            message=_ "Attack! Let's pay the pink-skins back for losing at Abez!"
        [/message]

        [event]
        name=side 4 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=47,28
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 47 28}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=47,48,49
            y=29,28,28
            terrain=Rr^Pr/o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=3
            action=delete
            path=goal[target_3]
        [/modify_ai]

        [message]
            speaker=Asheviere
            message=_ "Everything is strictly according to my plan! Soldiers, march on, cleanse the city of the rebel plague!"
        [/message]

        [event]
        name=side 3 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=37,9
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 37 9}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=37,38,39
            y=8,8,9
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=2
            action=delete
            path=goal[target_2]
        [/modify_ai]

        [message]
            side=2
            canrecruit=yes
            message=_ "Soldiers, forward to the attack! Let's end the war in the citadel of de Ferrez!"
        [/message]

        [event]
        name=side 2 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=enemies_defeated 

	    [remove_object]
            id=Delfador
            object_id=halo_delfador
        [/remove_object]

        [message]
            speaker=Bazur
            message=_ "All the rebel chiefs have been killed! We have won this massacre!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "I can't believe it. The war is over! I survived, I'll see the peace!"
        [/message]

        [message]
            speaker=Delfador
            message=_ "Ah, the fool Richard has lost everything! Wesnoth needs a new ruler, but I don't see anyone who fits the role! It's time to move on to the backup plan."
        [/message]

        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        [store_unit]
            {FILTER id=Delfador}
            variable,kill=stored_Delfador,yes
        [/store_unit]
        {NAMED_UNIT 1 Roc $stored_Delfador.x $stored_Delfador.y roc_delfador "Delfador" (canrecruit=yes)} {FACING $stored_Delfador.facing}
        {ANIMATE_UNIT id=roc_delfador levelin}

        [delay]
            time=300 
        [/delay]

        {MOVE_UNIT id=roc_delfador 1 1}

        [kill]
            id=roc_delfador
            animate=no 
        [/kill]

        [message]
            speaker=Bazur
            message=_ "That Delfador of yours escaped."
        [/message]

        [message]
            speaker=Isolde
            message=_ "He wields destructive magic, but inside he's a coward and a deceiver. And that's a good thing - we'd be in trouble if he took part in every rebel battle!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "It's not fair that such a worm wields such power! I hope one day I'll kill him."
        [/message]

        [message]
            speaker=Isolde
            message=_ "That would be nice..."
        [/message]

        {SOUND "horn-signals/horn-7.ogg"}

        [delay]
            time=300
        [/delay]

        [message]
            speaker=Isolde
            message=_ "Do you hear that horn? I think the queen is entering the city."
        [/message]
        
        [hide_unit]
            side=1,2,3,4,5,6,7
        [/hide_unit]

        {FADE_TO_BLACK}

        {REMOVE_IMAGE 32 20}
        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [store_locations]
            terrain=*^Cov
            variable=castle
        [/store_locations]

        [foreach]
            array=castle
            index_var=i
            [do]
                {REMOVE_IMAGE $this_item.x $this_item.y}
            [/do]
        [/foreach]

        [kill]
            side=2,3,4,5,6,7
            canrecruit=no 
        [/kill]

        [put_to_recall_list]
            side=1
            canrecruit=no 
            [not]
                id=Isolde 
            [/not]
        [/put_to_recall_list]

        {TELEPORT_UNIT id=Bazur 31 19}
        {TELEPORT_UNIT id=Isolde 30 19}
        {TELEPORT_UNIT id=Henri 30 20}
        {TELEPORT_UNIT id=Ghuvog 33 19}

        [modify_unit]
            [filter]
                race=orc,human 
            [/filter]
            facing=s
        [/modify_unit]

        [scroll_to]
            x,y=32,20 
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {CAPTURE_VILLAGES 3 32 20 100}

        {FADE_IN}

        [unhide_unit]
            side=1,2,3,4
        [/unhide_unit]

        {REPLACE_SCENARIO_MUSIC main_menu.ogg}

        {UNIT 3 "Royal Guard" 49 29 (id=guard1)}
        {MOVE_UNIT id=guard1 48 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard2)}
        {MOVE_UNIT id=guard2 46 28}

        {UNIT 3 "Royal Guard" 49 29 (id=guard3)}
        {MOVE_UNIT id=guard3 45 26}

        {UNIT 3 "Royal Guard" 49 29 (id=guard4)}
        {MOVE_UNIT id=guard4 43 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard5)}
        {MOVE_UNIT id=guard5 42 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard6)}
        {MOVE_UNIT id=guard6 40 25}

        {UNIT 3 "Royal Guard" 49 29 (id=guard8)}
        {MOVE_UNIT id=guard8 39 23}

        {UNIT 3 "Royal Guard" 49 29 (id=guard9)}
        {MOVE_UNIT id=guard9 37 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard10)}
        {MOVE_UNIT id=guard10 36 21}

        {UNIT 3 "Royal Guard" 49 29 (id=guard11)}
        {MOVE_UNIT id=guard11 34 22}

        {TELEPORT_UNIT id=Asheviere 49 29}
        {MOVE_UNIT id=Asheviere 35 22}

        [scroll_to]
            x,y=32,20
        [/scroll_to]

        [message]
            speaker=Asheviere 
            message=_ "All the rebel leaders are dead, and Dan-Tonk lies at my feet. To whom do I owe this triumph?"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Me!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "<span size='small'>(punching Bazur in the side) Quiet, you.</span>"
        [/message]

        [message]
            speaker=Henri
            message=_ "We were only following Your Majesty's orders."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "It's true. I wish I could see Garard's face now. I believe I have bested him in the art of war?"
        [/message]

        [message]
            speaker=Henri
            message=_ "Quite right, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "However, even the wisest order is nothing without capable executors. I am glad to have such subjects at my hand."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Isolde, you've served me well. I see you've managed to rein in a band of orcs and accomplish a special task. Not every one of my commanders can do that."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Hand me a sword!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Take mine, queen!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "...Thank you. Kneel, Isolde. For your services to the kingdom, I knight you. Rise, madam, and wear your title with honor! I hope you will continue to serve the Crown faithfully."
        [/message]

        [message]
            speaker=Isolde
            message=_ "I... I will carry the sword until Your Majesty considers my duty done."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Excellent."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "General Henri, you were one of Garard's closest men, and I'll be honest, I doubted you at first. But you've proven your loyalty to the kingdom, not to a person, and I appreciate that. In gratitude for your service, I am appointing you commandant of Halstred Fortress, our great stronghold in the west."
        [/message]

        [message]
            speaker=Henri
            message=_ "I would be honored to lead Halstred, Your Majesty! Rest assured, as long as I live, no enemy will penetrate its walls."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "As for you, Ghuvog, you have done me an invaluable favor, and have avenged your enemies sufficiently. You may return to your lands, or you may stay with me and recognize me as your sovereign."
        [/message]

        [message]
            speaker=Ghuvog
            message=_ "I'll stay with you, Asheviere. I recognize your dominance."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I'm glad to hear that. Perhaps together we can build a better world for both humans and orcs."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "And finally, a Whitefang orc. What was his name?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "His name is Bazur, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Ah, yes, Bazur. You've been one of the best orcs to enter my service; you've obeyed orders faithfully, and you've been the least likely to abuse my favour. I will make your band my personal guard. You will come with me to Weldyn, where you will receive a proper welcome and be armed with the best of my armoury."
        [/message]
        
        [message]
            speaker=Bazur
            message=_ "Now that sounds like a worthy award to me, finally!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I'll pretend I didn't notice the behaviour and there's another chance for you to respond appropriately."
        [/message]

        [message]
            speaker=Isolde
            message=_ "<span size='small'>Answer: I serve Your Majesty.</span>"
        [/message]

        [message]
            speaker=Bazur
            message=_ "I serve Your Majesty!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "That's better. General Henri, has Dan-Tonk's citadel survived?"
        [/message]

        [message]
            speaker=Henri
            message=_ "Mostly survived, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Then I'll have a feast there in honour of our victory. You are all invited."
        [/message]

        [message]
            speaker=Henri
            message=_ "Hurrah for Your Majesty!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Ghuvog
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "HURRA-A-A-AH!"
        [/message]

        [endlevel]
            linger_mode=no
            result=victory 
            bonus=yes 
            carryover_add=yes 
            carryover_percentage=40 
        [/endlevel]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Sir_Aran 
        [/filter] 

        [message]
            speaker=unit 
            message=_ "I will not run from fate again. I curse you, Asheviere, doom of Wesnoth!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You have annoyed me too much, Aran, to give you a glorious death. Orcs, cut off his head!"
        [/message]

        [message]
            race=orc
            scroll=no
            message=_ "Gladly!"
        [/message]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Sir_Grey
        [/filter] 

        [message]
            speaker=unit 
            message=_ "You have won, Asheviere, I surrender to your mercy."
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "It's too late to give up, Grey, you missed your chance at Weldyn. Wizards, roast the rascal in your own armor!"
        [/message]

        [message]
            type=Arch Mage
            scroll=no
            message=_ "Oh... Yes, Your Majesty..."
        [/message]

        {SOUND flame-big.ogg}
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Baron_Richard
        [/filter] 

        [message]
            speaker=unit 
            message=_ "Cowards, you idiots! Garard must be weeping if the dead can weep!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You could have been king of Wesnoth, but you chose a dead drunkard king over a living queen. How does it feel to realize that before you die, Richard?"
        [/message]

        [message]
            speaker=unit 
            message=_ "Only a complete idiot would let himself be drawn into your net, Ashevir! I have remained loyal to Garard and kingdom, I have no regrets. End it soon, I can't wait to see how the reign of a lonely, resentful woman ends!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "!!!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "Hang him from the tower!"
        [/message]
    [/event]

    [event]
    name=turn 5
    first_time_only=yes

        [if]

        [have_unit]
            id=Baron_Richard 
        [/have_unit]

        [then]

        [unit]
            id=Delfador
            name= _ "Delfador"
            side=7
            unrenamable=yes
            type=Roc
            x,y=1,1
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        {MOVE_UNIT type=Roc 5 7}
        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        {TRANSFORM_UNIT id=Delfador "Delfador L4"}
        
        [transform_unit]
        	id=Delfador
        	transform_to=Delfador L4
        [/transform_unit]

        [message]
            speaker=Delfador 
            message=_ "Looks like I'm not too late, the city's still standing! That's good, that means there's hope for us!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "Delfador, you damned deceiver, where have you been all this time?!"
        [/message]

        [message]
            speaker=Delfador 
            message=_ "Please forgive me for the delay, Sir Richard, I was working for the good of our cause!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "While you were scheming, we were defeated and surrounded in our own city! Enough of this, unleash the full power of your magic on the Asheviere horde, it's the only thing that will help the cause!"
        [/message]

        [message]
            speaker=Delfador 
            message=_ "No, listen to me, this defense is doomed to failure. I can open a portal and get you to safety, then-"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "Can't you hear me, magician? I said enough of this. I'm not running away from my own city, and I'm not going to participate in your schemes. Wesnoth's fate is decided here and now - help me, or get out!"
        [/message]

        [message]
            speaker=Delfador 
            message=_ "Oh, whatever you say, Baron! I will do everything in my power to bring us victory!"
        [/message]

        {FLASH_BLUE (
        [sound]
            name=lightning.ogg
        [/sound]
        )} 

        [terrain]
            x,y=5,7
            radius=1
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=5,7
            terrain=Gg
        [/terrain]

        [terrain]
            x,y=7,7
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=5,9
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=3,6
            terrain=Qxua^Es 
        [/terrain]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Asheviere
            message=_ "I'm surprised you had the courage to come here, Delfador. You wanted to witness the fall of Dan-Tonk in person?"
        [/message]

        [message]
            speaker=Delfador
            message=_ "Whose downfall I want to see is yours, Asheviere."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Why? Have I been harsh with you? Join me, you'll be as honored in my service as you were under Garard."
        [/message]

        [message]
            speaker=Delfador
            message=_ "I owe everything I have to Garard, and I will not betray him even in death."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Then you will die like all his henchmen!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Who is this Delfador? "
        [/message]

        [message]
            speaker=Isolde
            message=_ "Court mage, hero of Wesnoth. He was the one who made the orcs and lizards fight each other at Abez Crossing and brought victory."
        [/message]

        [message]
            speaker=Bazur
            message=_ "That rascal! Then I must get him!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Don't talk nonsense, concentrate on our mission! And prepare for the worst - if Delfador really is as strong as they say, the sky itself will soon fall upon us..."
        [/message]
        
        [object]
        	id=halo_delfador
            take_only_once=no
            duration=forever
            [filter]
                id=Delfador
            [/filter]
            [effect]
		    apply_to=halo
		    halo="halo/ring-[1~3].png:100"
		[/effect]
        [/object]

        [event]
        name=first_light
        first_time_only=yes 

            [message]
                speaker=Delfador
                message=_ "That's for Garard, you wretches!"
            [/message]
        [/event]

        [event]
        name=new_turn 
        first_time_only=no 

            [fire_event]
                name=first_light
            [/fire_event]

            {REPEAT {ON_DIFFICULTY 3 4 5} (

            [store_unit]
                [filter]
                    side=2,3,4
                    canrecruit=no 
                [/filter]
                kill=no 
                variable=target 
            [/store_unit]

            {VARIABLE target_random_limit $target.length}
            {VARIABLE_OP target_random_limit sub 1}
            {RANDOM 0..$target_random_limit}

            [object]
				id=struck_by_lightning
           	 	take_only_once=no
            	duration=turn
                silent=yes
                [filter]
                    id=$target[$random].id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=struck_by_lightning
                    range=ranged
                    damage=0
                    attacks=0
                    type=fire
                [/effect]
                [effect]
                    apply_to=new_animation
                    id=struck_by_lightning

                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                [/effect]
            [/object]

            {MODIFY_UNIT id=$target[$random].id facing n}

            [sound]
                name=lightning.ogg 
            [/sound]

            [animate_unit]
                flag=attack
                [filter]
                    id=$target[$random].id
                [/filter]
                [primary_attack]
                    name=struck_by_lightning
                [/primary_attack]
                hits=yes
            [/animate_unit]

            [harm_unit]
			    [filter]
                    id=$target[$random].id
			    [/filter]
			    amount=25
			    damage_type=fire
			    slowed=no
			    fire_event=yes
			    experience=no
			    kill=yes
			    animate=yes
		    [/harm_unit]

            [remove_object]
                id=$target[$random].id
                object_id=struck_by_lightning
            [/remove_object]
            
            {CLEAR_VARIABLE target}
            )}

        [/event]
        [/then]

        [else]
        [/else]
        [/if]
    [/event]

    [event]
    name=die 

        [filter]
            id=Baron_Richard 
        [/filter]

        [filter_attack_second]
            type=blade,pierce 
            range=ranged 
        [/filter_attack_second]

        [set_achievement]
            content_for=AD_Achievements
            id=AD_S7_Armour
        [/set_achievement]
    [/event]
[/scenario]
