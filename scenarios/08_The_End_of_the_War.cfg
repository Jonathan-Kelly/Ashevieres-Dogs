#textdomain wesnoth-AD

[scenario]
    id=08_The_End_of_the_War
    name= _ "The End of the War"
    map_data="{~add-ons/Ashievieres_Dogs/maps/08_The_End_of_the_War.map}"

    [event]
    name=prestart,new_turn
    first_time_only=no

        {LIGHT_EFFECT ""}
    [/event] 

    [event]
    name=prestart

        {PLACE_FIRE 40 17}
        {PLACE_FIRE 38 17}

        {PLACE_FIRE 26 22}
        {PLACE_FIRE 31 12}
        {PLACE_FIRE 21 20}
    [/event]

    {IMPLEMENT_FIRES}

    turns=-1
    next_scenario=null
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes
    current_time=4

    {DEFAULT_SCHEDULE}

    {SCENARIO_MUSIC "through_the_gates.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_city_falls.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
    {EXTRA_SCENARIO_MUSIC "battle.ogg"}
    {EXTRA_SCENARIO_MUSIC "suspense.ogg"}

    {AD_TRACK {JOURNEY_07_NEW} }

    [label]
        x,y=38,8
        text=_ "Northern gates"
        immutable=yes
    [/label]

    [label]
        x,y=48,28
        text=_ "Eastern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,23
        text=_ "Southern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,12
        text=_ "Dan-Tonk citadel"
        immutable=yes
    [/label]

    #define FIREBALL MAGE_ID X Y

        [animate_unit]
            flag=attack
                [filter]
                    id={MAGE_ID}
                [/filter]
                [facing]
                    x,y=15,12
                [/facing]
                [primary_attack]
                    range=ranged
                    type=fire
                [/primary_attack]
            hits=yes
        [/animate_unit]

        [scroll_to]
            x,y={X},{Y}
        [/scroll_to]

        {QUAKE "explosion.ogg"}
        {QUAKE "rumble.ogg"}
        {QUAKE "cave-in.ogg"}

        [item]
            halo="data/add-ons/Ashievieres_Dogs/images/projectiles/fireball-impact-[1~17].png"
            x={X}
            y={Y}
        [/item]

        [delay]
            time=900
        [/delay]

        [harm_unit]
            [filter]
                [filter_location]
                    x,y={X},{Y}
                [/filter_location]
            [/filter]
            damage_type=fire
            amount=25
            kill=yes
            fire_event=yes
            animate=yes
            experience=no
        [/harm_unit]

        {REMOVE_IMAGE {X} {Y}}

        {PLACE_FIRE {X} {Y}}    
    #enddef

    {STARTING_VILLAGES_ALL 7}

    {STARTING_VILLAGES 2 12}
    {STARTING_VILLAGES 3 12}
    {STARTING_VILLAGES 4 6}

    {STARTING_VILLAGES_AREA 5 32 27 10}
    {STARTING_VILLAGES_AREA 6 40 16 8}
    {STARTING_VILLAGES_AREA 6 47 22 5}
   

    [event]
    name=prestart 

        [capture_village]
            side=2
            x=57,57,32,13,7,39
            y=14,9,4,7,10,4
        [/capture_village]

        [capture_village]
            side=3
            x=36,29
            y=44,43
        [/capture_village]

        [capture_village]
            side=4
            x=6,12,5,19
            y=40,35,22,42
        [/capture_village]
    [/event]

    [side]
        side=1
        controller=human
        gold=250
        {INCOME 5 3 1}
        fog=no
        shroud=no
        share_vision=all
        {BAZUR_ARC_I}
        color=white
        team_name=bazur
        user_team_name= _ "Asheviere's Forces"
        {FLAG_VARIANT ragged}
        save_id=bazur
    [/side]

    [side]
        side=2
        controller=ai
        gold=185
        income=9
        fog=no
        shroud=no
        share_vision=all
        {HENRI}
        recruit=Spearman,Pikeman,Javelineer,Bowman,Longbowman,Shock Trooper,Mage,Dragoon,Fencer,Cavalryman
        color=silver
        team_name=bazur
        user_team_name= _ "Asheviere's Forces"
        {FLAG_VARIANT loyalist}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            recruitment_pattern=fighter,fighter,archer 
        [/ai]
    [/side]

    [side]
        {ASHEVIERE}
        color=red
        side=3
        controller=ai
        canrecruit=yes
        recruit=Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant
        gold=185
        income=10
        team_name=bazur
        user_team_name=_"Asheviere's Forces"
        {FLAG_VARIANT loyalist}
        save_id=queen
        [ai]
            {NO_SCOUTS}
            aggression=0.88
        [/ai]
    [/side]

    [side]
        defeat_condition=never
        color=black
        side=4
        controller=ai
        
        no_leader=yes
        gold=185
        income=16
        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman
        team_name=bazur
        user_team_name=_"Asheviere's Forces"
        {FLAG_VARIANT ragged}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        {GOLD 150 175 200}
        income=13
        fog=no
        shroud=no
        share_vision=all
        {SIR_GREY}
        recruit=Heavy Infantryman,Shock Trooper,Iron Mauler,Peasant,Woodsman
        color=purple
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping={ON_DIFFICULTY defensive offensive no}
        [/ai]
    [/side]

    [side]
        side=6
        controller=ai
        {GOLD 150 175 200}
        income=11
        fog=no
        shroud=no
        share_vision=all
        {SIR_ELLAENT}
        recruit=Horseman,Knight,Lancer,Peasant,Woodsman
        color=blue
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping={ON_DIFFICULTY defensive offensive no}
        [/ai]
    [/side]

    [side]
        side=7
        controller=ai
        {GOLD 200 250 300}
        income=12
        fog=no
        shroud=no
        share_vision=all
        {BARON_RICHARD}
        recruit=Swordsman,Pikeman,Javelineer,Halberdier,Spearman,Lieutenant,Sergeant,Royal Guard,Bowman,Longbowman,Peasant,Woodsman
        color=green
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping={ON_DIFFICULTY defensive offensive no}
        [/ai]
    [/side]

    {PEASANT_SIDE 8}
    {AD_CAPTURE_EVENT 8}
    
    {AD_RECRUIT_EVENT}
    {AD_LOYALS_EVENTS}

    {AD_MARAUDERS}
    {HERODEATH_ACT_I}

    #define IF_HAVE_RECALL SIDE WML

    [if]
    [have_unit]
        role=recall_{SIDE}
        search_recall_list=yes
    [/have_unit]

    {WML}
    [/if]
    #enddef

    [event]
    name=side 3 turn 
    first_time_only=no 

        {IF_HAVE_RECALL 3 (
        [then]
            {MODIFY_UNIT id=Asheviere extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Asheviere extra_recruit "Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant"}
        [/else])}
    [/event]

    [event]
    name=recall
    first_time_only=no 

        [filter]
            side=3
        [/filter]

        {MODIFY_UNIT find_in=unit role ""}

        {IF_HAVE_RECALL 3 (
        [then]
            {MODIFY_UNIT id=Asheviere extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Asheviere extra_recruit "Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant"}
        [/else])}
    [/event]

    [event]
    name=side 4 turn 
    first_time_only=no 

        {IF_HAVE_RECALL 4 (
        [then]
            {MODIFY_UNIT id=Ghuvog extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Ghuvog extra_recruit "Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman"}
        [/else])}
    [/event]

    [event]
    name=recall
    first_time_only=no 

        [filter]
            side=4
        [/filter]

        {MODIFY_UNIT find_in=unit role ""}

        {IF_HAVE_RECALL 4 (
        [then]
            {MODIFY_UNIT id=Ghuvog extra_recruit ""}
        [/then]

        [else]
            {MODIFY_UNIT id=Ghuvog extra_recruit "Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman"}
        [/else])}
    [/event]

    [event]
    name=prestart 

        {LOYAL_UNIT 5 "Shock Trooper" 31 35}{GUARDIAN}
        {LOYAL_UNIT 5 "Shock Trooper" 33 35}{GUARDIAN}

        {LOYAL_UNIT 6 Knight 45 14}{GUARDIAN}

        {LOYAL_UNIT 7 Halberdier 16 15}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 18 14}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 19 13}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 19 11}{GUARDIAN}

        {IF_VAR Grey_defeated numerical_equals 1 (
            [then]
                [gold]
                    side=5
                    amount=-75 
                [/gold]
            [/then]
            )}

        {IF_VAR Ellaent_defeated numerical_equals 1 (
        [then]
            [gold]
                side=6 
                amount=-75 
            [/gold]
        [/then]
        )}

        {IF_VAR Richard_defeated numerical_equals 1 (
            [then]
                [gold]
                    side=7
                    amount=-75 
                [/gold]
            [/then]
            )}

        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [unstore_unit]
            variable=ghuvog 
            x,y=3,30
        [/unstore_unit]

        {MODIFY_UNIT id=Ghuvog side 4}
        {FULL_HEAL id=Ghuvog}

        [foreach]
            array=orc_recalls
            index_var=i 

            [do]
                {VARIABLE this_item.side 4}

                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall 
                [/unstore_unit]
            [/do]
        [/foreach]

        [hide_unit]
            side=1
        [/hide_unit]

        {UNIT 3 "Arch Mage" 50 35 (
        id=BattleMage1
        ai_special=guardian 
        facing=nw
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        )}
        {UNIT 3 "Red Mage" 51 35 (
        id=BattleMage2
        ai_special=guardian 
        facing=nw
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        )}

        {UNIT 3 "Great Mage" 53 34 (
        id=Leollyn
        name=_ "Leollyn"
        profile=portraits/leollyn.webp
        ai_special=guardian 
        facing=nw
        [modifications]
            {TRAIT_AGED}
            {TRAIT_INTELLIGENT}
            {TRAIT_LOYAL_HERO_NOSLOT}
        [/modifications]
        )}
        
        {UNIT 3 "Red Mage" 54 33 (
        id=BattleMage4
        ai_special=guardian 
        
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        )}

        {LOYAL_UNIT 7 Halberdier 36 8}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 38 9}{GUARDIAN}

        {LOYAL_UNIT 7 Halberdier 48 27}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 46 28}{GUARDIAN}

        {LOYAL_UNIT 7 Halberdier 18 23}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 16 22}{GUARDIAN}

        {MODIFY_AI_ADD_GOAL 2 (
            [goal]
                id=target_2
                name=target_location
                [criteria]
                    x,y=39,8
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 3 (
            [goal]
                id=target_3
                name=target_location
                [criteria]
                    x,y=49,29
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 4 (
            [goal]
                id=target_4
                name=target_location
                [criteria]
                    x,y=15,24
                [/criteria]
                value=50
            [/goal]
        )}
    [/event]

    [event]
    name=start 

        [delay]
            time=300
        [/delay]

        {REMOVE_IMAGE 32 20}

        {PLACE_IMAGE scenery/trapdoor-open.png 32 20}

        [sound]
            name=mace-miss.ogg 
        [/sound]

        [delay]
            time=300
        [/delay]

        [unhide_unit]
            side=1
        [/unhide_unit]

        {MOVE_UNIT id=Bazur 31 20}

        [recall]
            id=Isolde 
            x,y=32,20
            animate=no
        [/recall]

        {MOVE_UNIT id=Isolde 33 20}

        [if]
            [have_unit]
                id=Ron 
                side=1
            [/have_unit]
        [then]

            [recall]
                id=Ron
                x,y=32,20
                animate=no
            [/recall]

            {MOVE_UNIT x,y=32,20 32 21}
        [/then]

        [else]
            [recall]
                side=1
                x,y=32,20
                animate=no
            [/recall]

            {MOVE_UNIT x,y=32,20 32 21}
        [/else]
        [/if]

        [if]
        [variable]
            name=save_chu 
            numerical_equals=1
        [/variable]

        [then]

        {REPEAT 6 (

        [recall]
            side=1
            race=monster
            x,y=32,20
            animate=yes
        [/recall])}

        [/then]

        [/if]

        [message]
            speaker=Bazur 
            message=_ "Whoa, what a blast!!!"
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Keep fireballing the city. I want the rebel walls turned to dust before my fighters storm the gates."
        [/message]

        [message]
            speaker=Leollyn
            message=_ "Your Majesty, please do remember that our goal is not to destroy the city, but to capture it."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Do as you're told, or you'll be capturing it yourself — from the front lines!"
        [/message]

        [message]
            speaker=Leollyn
            message=_ "(I never thought I'd live to serve a queen like this!)"
        [/message]

        {FIREBALL Leollyn 30 14}

        [delay]
            time=300
        [/delay]

        {FIREBALL BattleMage4 29 26}

        [message]
            speaker=Sir_Ellaent
            message=_ "The royal mages are bombarding the city! De Ferres, what do we do?"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "At the battle of Weldyn you did not ask me what to do, Ellaent, but now you speak?"
        [/message]
        
        [message]
            speaker=Baron_Richard
            message=_ "I'll tell you what to do: defend Dan'Tonk to our last drop of blood; be the rock against which Asheviere will break her teeth! They will tear themselves apart, they will run, and on their heels we will enter Weldyn, and you will recognize me as regent! Any objections?"
        [/message]

        [message]
            speaker=Sir_Ellaent
            message=_ "Not at all, my Lord Regent!"
        [/message]

        [message]
            speaker=Sir_Grey
            message=_ "There's no turning back now; it's to Weldyn or to the grave. I'm with you, Richard!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "To the walls, then! Let's show this rebel scum that the spirit of Garard still lives!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "We must break through to the gates and open them to the royal army at once, or we will be crushed!"
        [/message]

        {PLACE_IMAGE items/gohere.png 37 9}

        [scroll_to]
            x,y=37,9
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 47 28}

        [scroll_to]
            x,y=47,28
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 17 23}

        [scroll_to]
            x,y=17,23
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        [terrain]
            x,y=32,20
            radius=1
            terrain=^Cov
            layer=overlay
        [/terrain]

        [terrain]
            x,y=32,20
            terrain=^Kov
            layer=overlay
        [/terrain]

        [store_locations]
            terrain=*^Cov
            variable=castle
        [/store_locations]

        [foreach]
            array=castle
            index_var=i
            [do]
                [item]
                    x=$this_item.x
                    y=$this_item.y
                    image="items/gohere-empty.png"
                [/item]        
            [/do]
        [/foreach]
        
        [scroll_to_unit]
            id=Bazur 
        [/scroll_to_unit]

        [objectives]
            silent=no
                [objective]
                    description= _ "Open each gate by moving any unit to the marked hexes in front of each gate, so that your allies may enter"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Defeat the rebel leaders"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Bazur"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Isolde"
                    condition=lose
                [/objective]
                {IS_LAST_SCENARIO}
                [note]
                    description=_ "The hex with the trapdoor works as a citadel, and the marked hexes around it work as a castle."
                [/note]
                [note]
                    [show_if]
                        {VARIABLE_CONDITIONAL Ellaent_defeated numerical_equals 1}
                    [/show_if]
                    description=_ "Since you defeated Sir Ellaent in the Battle of Weldyn, he has 75 less gold."
                [/note]
                [note]
                    [show_if]
                        {VARIABLE_CONDITIONAL Grey_defeated numerical_equals 1}
                    [/show_if]
                    description=_ "Since you defeated Sir Grey in the Battle of Weldyn, he has 75 less gold."
                [/note]
                [note]
                    [show_if]
                        {VARIABLE_CONDITIONAL Richard_defeated numerical_equals 1}
                    [/show_if]
                    description=_ "Since you defeated Baron Richard in the Battle of Weldyn, he has 75 less gold."
                [/note]
        [/objectives]
    [/event]

    [event]
    name=turn 2

        {FIREBALL BattleMage1 16 18}
        {FIREBALL BattleMage4 37 28}
    [/event]

    [event]
    name=turn 3

        {FIREBALL BattleMage2 38 25}
        {FIREBALL Leollyn 39 16}
    [/event]

    [event]
    name=turn 4
        {FIREBALL BattleMage2 22 12}
        {FIREBALL Leollyn 26 16}
    [/event]

    [event]
    name=turn 5
        {FIREBALL BattleMage1 33 14}
        {FIREBALL BattleMage4 24 29}
    [/event]

    [event]
    name=turn 6
        {FIREBALL BattleMage1 24 15}
        {FIREBALL BattleMage4 48 17}
    [/event]

    #define CHECK_GATES

        [if]
            [variable]
                name=unit.race 
                equals=human 
            [/variable]
        [then]
            {VARIABLE_OP gates_human add 1}

            [if]
                [variable]
                    name=gates_human 
                    numerical_equals=3
                [/variable]
            [then]
                [set_achievement]
                    content_for=ashevieres_dogs
                    id=ad_offical
                [/set_achievement]
            [/then]
            [/if]
        [/then]
        [/if]
    #enddef

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=17,23
            [/filter_location]
        [/filter] 

        {REMOVE_IMAGE 17 23}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=15,16,17
            y=23,23,24
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=4
            action=delete
            path=goal[target_4]
        [/modify_ai]

        [message]
            speaker=Ghuvog
            message=_ "Attack! Let's pay back the pink-skins for their victory at the Abez!"
        [/message]

        [event]
        name=side 4 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=47,28
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 47 28}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=47,48,49
            y=29,28,28
            terrain=Rr^Pr/o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=3
            action=delete
            path=goal[target_3]
        [/modify_ai]

        [message]
            speaker=Asheviere
            message=_ "Everything is going smoothly according to plan. Soldiers, march on, and cleanse the city of the rebel plague!"
        [/message]

        [event]
        name=side 3 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=37,9
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 37 9}

        [message]
            speaker=unit 
            message=_ "I'm opening the gates!"
        [/message]

        [terrain]
            x=37,38,39
            y=8,8,9
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=2
            action=delete
            path=goal[target_2]
        [/modify_ai]

        [message]
            side=2
            canrecruit=yes
            message=_ "Soldiers, attack! Forward, and we shall end this war in de Ferres's citadel!"
        [/message]

        [event]
        name=side 2 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=enemies_defeated 

	    [remove_object]
            id=Delfador
            object_id=halo_delfador
        [/remove_object]

        [message]
            speaker=Bazur
            message=_ "All the rebel chiefs have been killed! We won the massacre!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "I can't believe it. The war is over! I survived, I'll live to see peace!"
        [/message]

        [message]
            speaker=Delfador
            message=_ "Alas, the city is lost! The triumph of Asheviere is the ruin of Wesnoth, for her rule shall surely be the death of all we have fought for. Only one forlorn hope now remains..."
        [/message]

        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        [store_unit]
            {FILTER id=Delfador}
            variable,kill=stored_Delfador,yes
        [/store_unit]
        {NAMED_UNIT 1 Roc $stored_Delfador.x $stored_Delfador.y roc_delfador "Delfador" (canrecruit=yes)} {FACING $stored_Delfador.facing}
        {ANIMATE_UNIT id=roc_delfador levelin}

        [delay]
            time=300 
        [/delay]

        {MOVE_UNIT id=roc_delfador 1 1}

        [kill]
            id=roc_delfador
            animate=no 
        [/kill]

        [message]
            speaker=Bazur
            message=_ "That Delfador of yours escaped."
        [/message]

        [message]
            speaker=Isolde
            message=_ "His magic may be powerful, but inside he's nothing but a coward and a deceiver. And that's a good thing — we'd be in trouble if he'd taken part in every rebel battle!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "It's not fair that such a worm wields such power! I hope one day I'll kill him."
        [/message]

        [message]
            speaker=Isolde
            message=_ "That would be nice..."
        [/message]

        {SOUND "horn-signals/horn-7.ogg"}

        [delay]
            time=300
        [/delay]

        [message]
            speaker=Isolde
            message=_ "Do you hear that horn? I think the queen is entering the city."
        [/message]
        
        [hide_unit]
            side=1,2,3,4,5,6,7
        [/hide_unit]

        {FADE_TO_BLACK}

        {REMOVE_IMAGE 32 20}
        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [store_locations]
            terrain=*^Cov
            variable=castle
        [/store_locations]

        [foreach]
            array=castle
            index_var=i
            [do]
                {REMOVE_IMAGE $this_item.x $this_item.y}
            [/do]
        [/foreach]

        [kill]
            side=2,3,4,5,6,7
            canrecruit=no 
        [/kill]

        [put_to_recall_list]
            side=1
            canrecruit=no 
            [not]
                id=Isolde 
            [/not]
        [/put_to_recall_list]

        {TELEPORT_UNIT id=Bazur 31 19}
        {TELEPORT_UNIT id=Isolde 30 19}
        {TELEPORT_UNIT id=Henri 30 20}
        {TELEPORT_UNIT id=Ghuvog 30 21}

        {FULL_HEAL canrecruit=yes}

        [modify_unit]
            [filter]
                race=orc,human 
            [/filter]
            facing=s
        [/modify_unit]

        [scroll_to]
            x,y=32,20 
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {CAPTURE_VILLAGES 3 32 20 100}

        {FADE_IN}

        [unhide_unit]
            side=1,2,3,4
        [/unhide_unit]

        {REPLACE_SCENARIO_MUSIC main_menu.ogg}

        {UNIT 3 "Royal Guard" 49 29 (id=guard1)}
        {MOVE_UNIT id=guard1 48 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard2)}
        {MOVE_UNIT id=guard2 46 28}

        {UNIT 3 "Royal Guard" 49 29 (id=guard3)}
        {MOVE_UNIT id=guard3 45 26}

        {UNIT 3 "Royal Guard" 49 29 (id=guard4)}
        {MOVE_UNIT id=guard4 43 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard5)}
        {MOVE_UNIT id=guard5 42 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard6)}
        {MOVE_UNIT id=guard6 40 25}

        {UNIT 3 "Royal Guard" 49 29 (id=guard8)}
        {MOVE_UNIT id=guard8 39 23}

        {UNIT 3 "Royal Guard" 49 29 (id=guard9)}
        {MOVE_UNIT id=guard9 37 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard10)}
        {MOVE_UNIT id=guard10 36 21}

        {UNIT 3 "Royal Guard" 49 29 (id=guard11)}
        {MOVE_UNIT id=guard11 34 22}

        {TELEPORT_UNIT id=Asheviere 49 29}
        {MOVE_UNIT id=Asheviere 35 22}

        [scroll_to]
            x,y=32,20
        [/scroll_to]

        [message]
            speaker=Asheviere 
            message=_ "All the rebel leaders are dead, and Dan'Tonk lies at my feet. To whom do I owe this triumph?"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Me!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "<span size='small'>(punching Bazur in the side) Quiet, you.</span>"
        [/message]

        [message]
            speaker=Henri
            message=_ "We were only following Your Majesty's orders."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "As it should be. I almost wish Garard yet lived, if only so I could now see his face. I do believe I've bested him in the art of war?"
        [/message]

        [message]
            speaker=Henri
            message=_ "Quite right, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "However, even the wisest orders mean nothing without capable executors. I am glad to have such subjects at hand."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Isolde, you've served me well. I see you've managed to infiltrate the city, and to even rein in a band of orcs. Not any commanders can do that."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Hand me a sword!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Take mine, queen!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "...Thank you. Kneel, Isolde. For your services to the kingdom, I knight you. Rise, madam, and wear your title with honor! I hope you will continue to serve the Crown faithfully."
        [/message]

        [message]
            speaker=Isolde
            message=_ "I... I will carry the sword until Your Majesty considers my duty done."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Excellent."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "General Henri, you were one of Garard's officers. At first, I doubted you. But you've proven your loyalty to the kingdom, not just to a person, and I appreciate that. In gratitude for your service, I appoint you commandant of Halstred Fortress, our great stronghold in the west."
        [/message]

        [message]
            speaker=Henri
            message=_ "I would be honored to lead Halstred, Your Majesty! Rest assured, as long as I live, no enemy will breach its walls."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "As for you, Ghuvog, you have done me an invaluable favor, and have wrought great vengeance on your enemies. You may return to your lands, or you may stay with me and recognize me as your sovereign."
        [/message]

        [message]
            speaker=Ghuvog
            message=_ "Graah, my warriors and I will stay with all youse humans. Between Garard, the saurians, and the rebels, there's not much left of Clan Blackcrest."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I'm glad for your decision. I shall assuredly have great use for you and your clan in the coming years."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "And finally, a Whitefang orc. What was his name?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "His name is Bazur, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Ah, yes, Bazur. You've been one of the best orcs in my service; you've obeyed orders faithfully, and you've been the least likely to abuse my favour. You and your veterans shall be my personal guard. You will come with me to Weldyn, where you will receive a proper welcome and be equipped with the best of my armoury."
        [/message]
        
        [message]
            speaker=Bazur
            message=_ "Finally! Now that sounds like a worthy reward!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I'll pretend I didn't notice the behaviour and there's another chance for you to respond appropriately."
        [/message]

        [message]
            speaker=Isolde
            message=_ "<span size='small'>Answer: I serve Your Majesty.</span>"
        [/message]

        [message]
            speaker=Bazur
            message=_ "I serve Your Majesty!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "That's better. General Henri, is Dan'Tonk's citadel still intact?"
        [/message]

        [message]
            speaker=Henri
            message=_ "Mostly intact, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Then I'll have a feast there in honour of our victory. You are all invited."
        [/message]

        [message]
            speaker=Henri
            message=_ "Hurrah for Your Majesty!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Ghuvog
            message=_ "Hurrah!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "HURRA-A-A-AH!"
        [/message]

        [if]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_strong
            [/has_achievement]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_leaderkill
            [/has_achievement]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_training
            [/has_achievement]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_dark_queen
            [/has_achievement]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_armour
            [/has_achievement]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_ants
            [/has_achievement]
            [has_achievement]
                content_for=ashevieres_dogs 
                id=ad_offical
            [/has_achievement]
          
            [then]
                [endlevel] # bonus scenario
                    result=victory
                    next_scenario=ad_tutorial
                    carryover_percentage=0
                    carryover_report=no
                    linger_mode=no
                [/endlevel]
            [/then]
            [else]
                [endlevel] # end campaign
                    result=victory
                    carryover_report=no
                    linger_mode=no
                [/endlevel]
            [/else]
        [/if]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Sir_Ellaent 
        [/filter] 

        [message]
            speaker=unit 
            message=_ "I will not run from fate again. I curse you, Asheviere, doom of Wesnoth!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You have annoyed me too much, Ellaent, for me to give you a glorious death. Orcs, cut off his head!"
        [/message]

        [message]
            race=orc
            scroll=no
            message=_ "Gladly!"
        [/message]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Sir_Grey
        [/filter] 

        [message]
            speaker=unit 
            message=_ "You have won, Asheviere! I give myself up unto your mercy."
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "It's too late to give up, Grey. You missed your chance at Weldyn. Wizards, roast the rascal in your own armor!"
        [/message]

        [message]
            type=Arch Mage
            scroll=no
            message=_ "Oh... Yes, Your Majesty..."
        [/message]

        {SOUND flame-big.ogg}
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Baron_Richard
        [/filter] 

        [message]
            speaker=unit
            message=_ "Cowards, cowards, idiots! Garard must spinning in his grave!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You could have been king of Wesnoth, but you chose a dead drunkard king over a living queen. How does it feel to realize that as you die, Richard?"
        [/message]

        [message]
            speaker=unit 
            message=_ "Only a fool would let himself be drawn into your web of lies, Asheviere! I have remained loyal to my king and kingdom, and I have no regrets. I only wish I could live to see how your reign will end; the reign of a lonely, resentful woman!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "!!!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "Hang him from the tower!"
        [/message]

        [sound]
            name=tail.ogg 
        [/sound]
    [/event]

    [event]
    name=turn 5
    first_time_only=yes

        [if]

        [have_unit]
            id=Baron_Richard 
        [/have_unit]

        [then]

        [unit]
            id=Delfador
            name= _ "Delfador"
            side=7
            unrenamable=yes
            type=Roc
            x,y=1,1
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_INTELLIGENT}
            [/modifications]
            {TEAM_COLOR_OVERRIDE () purple}
        [/unit]
        
        {MOVE_UNIT type=Roc 5 7}
        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        {TRANSFORM_UNIT id=Delfador "Delfador L4"}
        
        [transform_unit]
            id=Delfador
            transform_to=Delfador L4
        [/transform_unit]

        [message]
            speaker=Delfador
            message=_ "I am not too late! De Ferres's colors still fly over Dan'Tonk!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "Delfador, you damned deceiver, where have you been all this time?!"
        [/message]

        [message]
            speaker=Delfador
            message=_ "Forgive me for the delay, de Ferres. I have been acting in secret, infiltrating Weldyn under Asheveire's very nose, and have only just returned from deep council with the elves of the Aethenwood. Good news: our hope for a king is not yet lost!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "That's all well and good, but while you were off scheming we were fighting and getting surrounded in our own city! Enough talk — unleash your magic against Asheviere's rebels! This battle can yet be won!"
        [/message]

        [message]
            speaker=Delfador 
            message=_ "I fear the situation is grave, de Ferres. Orcs rampage across the heartland — look, they have even entered within your very walls! To fight here is to risk the whole war. Your men are loyal and brave, but strength of character cannot triumph against strength of arms."
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "Do you suggest I abandon my own city? I shan't flee to some backwater port — Dan'Tonk is my home, and my home is where I shall stand. Wesnoth's fate will be decided here and now — now fight with me against the dark queen!"
        [/message]

        [message]
            speaker=Delfador 
            message=_ "So be it, Baron. Vengeance for our slain comrades, our slain friends, our slain king! Asheviere has sown war, and she shall reap death!"
        [/message]

        {FLASH_BLUE (
        [sound]
            name=lightning.ogg
        [/sound]
        )} 

        [terrain]
            x,y=5,7
            radius=1
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=5,7
            terrain=Gg
        [/terrain]

        [terrain]
            x,y=7,7
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=5,9
            terrain=Qxua^Es 
        [/terrain]

        [terrain]
            x,y=3,6
            terrain=Qxua^Es 
        [/terrain]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Asheviere
            #po: Asheviere's son, Eldred, is dead. To "reunite" Asheviere with him would be to kill her
            message=_ "I'm surprised you had the courage to come here, Delfador. Are you here to try and reunite me with my son?"
        [/message]

        [message]
            speaker=Delfador
            message=_ "It was my failures that gave you power, and it will be my successes that take it away. I am here to do the right thing, Asheviere."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Then you will die like all the others!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Who is this Delfador?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Court mage, hero of Wesnoth, “The Great”, etcetera. He was the one who turned the orcs and lizards against each other at the Ford of Abez, and finally ended Garard's War."
        [/message]

        [message]
            speaker=Bazur
            message=_ "That rascal! Then I must get him!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Don't talk nonsense, concentrate on our mission! And prepare for the worst — if Delfador really is as strong as they say, the sky itself will soon fall upon us..."
        [/message]
        
        [object]
        	id=halo_delfador
            take_only_once=no
            duration=forever
            [filter]
                id=Delfador
            [/filter]
            [effect]
                apply_to=halo
                halo="halo/ring-[1~3].png:100"
            [/effect]
        [/object]

        [event]
        name=first_light
        first_time_only=yes 

            [message]
                speaker=Delfador
                message=_ "That's for Garard, you wretches!"
            [/message]
        [/event]

        [event]
        name=new turn 
        id=dialog_timer
        first_time_only=no 

            {VARIABLE_OP timer add 1}
            {IF_VAR timer numerical_equals 3 (
            [then]
                [message]
                    speaker=Leollyn
                    message=_ "Delfador, this is madness! Garard is long gone, and whatever royal favoritism you enjoyed under him is gone too. For your own good, get off the battlefield and let bygones be bygones!"
                [/message]

                [message]
                    speaker=Delfador
                    message=_ "Leollyn, my old examiner. I can't believe my eyes! How can you fight by Asheviere's side after all she's done? She orchestrated Garard's assassination!"
                [/message]

                [message]
                    speaker=Leollyn
                    message=_ "Hmph! The way I hear it, you were more than complicit in those events. You forget that we are mages, not politicians. Whoever sits on the throne of Wesnoth, it's our duty to help them."
                [/message]

                [message]
                    speaker=Delfador
                    message=_ "I would never help an evil queen destroy human cities. I thought better of you, Leollyn."
                [/message]
                {CLEAR_VARIABLE timer}
                [remove_event]
                    id=dialog_timer 
                [/remove_event]
            [/then]
            )}
        [/event]

        [event]
        name=new_turn 
        first_time_only=no 

            [fire_event]
                name=first_light
            [/fire_event]

            {REPEAT {ON_DIFFICULTY 3 4 5} (

            [store_unit]
                [filter]
                    side=2,3,4
                    canrecruit=no 
                [/filter]
                kill=no 
                variable=target 
            [/store_unit]

            {VARIABLE target_random_limit $target.length}
            {VARIABLE_OP target_random_limit sub 1}
            {RANDOM 0..$target_random_limit}

            [object]
				id=struck_by_lightning
           	 	take_only_once=no
            	duration=turn
                silent=yes
                [filter]
                    id=$target[$random].id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=struck_by_lightning
                    range=ranged
                    damage=0
                    attacks=0
                    type=fire
                [/effect]
                [effect]
                    apply_to=new_animation
                    id=struck_by_lightning

                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-1-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-2-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                    [attack_anim]
                        missile_start_time=0
                        [filter_attack]
                            name=struck_by_lightning
                        [/filter_attack]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-1.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-2.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]

                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-3.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                        
                        [missile_frame]
                            duration=50
                            halo=halo/lightning-bolt-3-4.png
                            halo_y=-125
                            offset=0
                        [/missile_frame]
                    [/attack_anim]
                [/effect]
            [/object]

            {MODIFY_UNIT id=$target[$random].id facing n}

            [sound]
                name=lightning.ogg 
            [/sound]

            [animate_unit]
                flag=attack
                [filter]
                    id=$target[$random].id
                [/filter]
                [primary_attack]
                    name=struck_by_lightning
                [/primary_attack]
                hits=yes
            [/animate_unit]

            [harm_unit]
			    [filter]
                    id=$target[$random].id
			    [/filter]
			    amount=14
			    damage_type=fire
			    slowed=no
			    fire_event=yes
			    experience=no
			    kill=yes
			    animate=yes
		    [/harm_unit]

            [remove_object]
                id=$target[$random].id
                object_id=struck_by_lightning
            [/remove_object]
            
            {CLEAR_VARIABLE target}
            )}

        [/event]
        [/then]

        [else]
        [/else]
        [/if]
    [/event]

    [event]
    name=die 
    first_time_only=no 

        [filter]
            side=5,6,7
            canrecruit=yes 
        [/filter]

        [gold]
            side=5,6,7
            amount={ON_DIFFICULTY 45 75 105}
        [/gold]
    [/event]

    [event]
    name=turn 15 

        [event]
        name=last breath 

            [filter]
                race=human 
                [not]
                    id=Isolde 
                [/not]
            [/filter]

            [filter_second]
                race=numan 
                [not]
                    id=Isolde 
                [/not]
            [/filter_second]

            [message]
                speaker=unit 
                message=_ "$second_unit.name|? I thought you fell at the Ford, in battle against the orcs!"
            [/message]

            [message]
                speaker=second_unit 
                message=_ "It would have been better if we'd never met again, friend..."
            [/message]

            [message]
                speaker=unit
                message=_ "No... Curse this war!"
            [/message]
        [/event]
    [/event]

    [event]
    name=last breath 

        [filter]
            id=Baron_Richard
        [/filter]

        [filter_second_attack]
            type=pierce,blade 
            range=ranged 
        [/filter_second_attack]

        [set_achievement]
            content_for=ashevieres_dogs
            id=ad_armour
        [/set_achievement]
        
    [/event]
[/scenario]
